from flask import Flask
from flask import request
import requests

from jaeger_client import Config
from flask_opentracing import FlaskTracer
import opentracing

import json

app = Flask(__name__)

def get_common_api_status():

  # Fetch a list of pull requests on the opentracing repository
  #github_url = "https://api.github.com/repos/opentracing/opentracing-python/pulls"
  common_api_url = "http://common-api:8080/status"

  parent_span = flask_tracer.get_span()
  with opentracing.tracer.start_span('common-api', child_of=parent_span) as span:
    span.set_tag("http.url",common_api_url)

    r = requests.get(common_api_url)

    span.set_tag("http.status_code", r.status_code)
  
  with opentracing.tracer.start_span('parse-json', child_of=parent_span) as span:

    this_json = r.json()
    app.logger.info('this_json : LEGNTH' + str(len(this_json)))
    app.logger.info('this_json : JSON' +  str(this_json))
    span.set_tag("get_status_count", len(this_json))

    status_dict = this_json

    status_level = status_dict['level']
    status_description = status_dict['description']
    
    span.set_tag("status_level", status_level)
    span.set_tag("status_description", status_description)

  return 'OpenTracing Common API Status: ' + ', '.join(status_level) + ', '.join(status_description) + ','

def initialize_tracer():
  config = Config(
      config={
          'sampler': {'type': 'const', 'param': 1},
          'local_agent': {'reporting_host': 'jaeger','reporting_port': '6831',
            },
          'logging': True,
      },
      service_name='opentracing-flask')
  return config.initialize_tracer() # also sets opentracing.tracer

@app.route('/')
def hello():
    return get_common_api_status()
    #return "Welcome to Tracing example"

if __name__ == "__main__":
    flask_tracer = FlaskTracer(initialize_tracer, True, app)
    app.run(host ='0.0.0.0', port = 5000, debug = True)  